<?php
/** @var \Contestio\Connect\ViewModel\RouteChecker $viewModel */
$viewModel = $block->getData('view_model');

if ($viewModel->isContestioRoute() === false) {
  // If not contestio route, do not load React app
  return;
}

/** @var \Contestio\Connect\Block\React $block */
$iframeUrl = $block->getIframeUrl();
$queryParams = $block->getQueryParams();

?>

<style>
  /* Enlarge the container */
  main#maincontent {
    padding: 0 !important;
    max-width: 1400px !important;
    margin: 0 auto !important;
  }

  /* Make the container flex */
  .page-main>.columns,
  .page-main>.columns>.column.main {
    display: flex !important;
    width: 100% !important;
    max-width: 100% !important;
    padding: 0 !important;
    margin: 0 !important;
  }
</style>

<div class="contestio-container">
  <div class="contestio-loading" id="contestio-loading"></div>

  <iframe 
    id="contestio-iframe" 
    src="<?php echo $iframeUrl; ?><?php echo $queryParams; ?>"
    sandbo
    width="100%" 
    height="100%"
    frameborder="0" 
    allowfullscreen 
    sandbox="allow-scripts allow-same-origin allow-forms"
    class="contestio-iframe contestio-hidden">
  </iframe>
</div>

<script>
// Coordination globale
if (typeof window.contestioGlobal === 'undefined') {
  window.contestioGlobal = {
    iframeReady: false,
    customerDataLoaded: false,
    listenersSetup: false,
    callbacks: []
  };
}

if (typeof window.initContestio === 'undefined') {
  window.initContestio = () => {
    console.log('Contestio: React init starting');
    
    let isIframeShown = false;
    let timeoutId = null;

    const showIframe = () => {
      if (isIframeShown) {
        console.log('Contestio: Iframe already shown');
        return;
      }
      
      isIframeShown = true;
      
      if (timeoutId) {
        clearTimeout(timeoutId);
        timeoutId = null;
      }

      const loading = document.getElementById('contestio-loading');
      const iframe = document.getElementById('contestio-iframe');

      if (!loading || !iframe) {
        console.error('Contestio: Elements not found');
        return;
      }

      console.log('Contestio: Showing iframe');
      loading.style.display = 'none';
      iframe.classList.remove('contestio-hidden');
      
      // ✅ COORDINATION: Notifier que l'iframe est prête
      window.contestioGlobal.iframeReady = true;
      
      // Exécuter les callbacks en attente
      window.contestioGlobal.callbacks.forEach(callback => {
        try {
          callback();
        } catch (error) {
          console.error('Contestio: Callback error:', error);
        }
      });
      window.contestioGlobal.callbacks = [];
    }

    // Timeout de sécurité
    timeoutId = setTimeout(() => {
      console.log('Contestio: Security timeout reached');
      showIframe();
    }, 8000);

    console.log('Contestio: Fetching customer data');

    fetch('/contestio/ajax/customerData')
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Contestio: Customer data received', data);
        
        // ✅ COORDINATION: Marquer les données comme chargées
        window.contestioGlobal.customerDataLoaded = true;
        
        const iframe = document.getElementById('contestio-iframe');

        if (!iframe) {
          console.error('Contestio: Iframe not found');
          showIframe();
          return;
        }

        if (data.customer_id && data.customer_email) {
          console.log('Contestio: User connected, updating iframe URL');
          
          // Event listener AVANT changement de src
          iframe.onload = function() {
            console.log('Contestio: Iframe loaded successfully');
            
            // ✅ DÉLAI SAFARI iOS: Attendre un peu avant de montrer
            setTimeout(() => {
              showIframe();
            }, 200);
          };

          // Timeout spécifique pour utilisateurs connectés
          const loginTimeout = setTimeout(() => {
            console.log('Contestio: Login timeout reached');
            showIframe();
          }, 6000);

          // Clear le timeout si onload se déclenche
          const originalOnload = iframe.onload;
          iframe.onload = function() {
            clearTimeout(loginTimeout);
            originalOnload();
          };

          // Construire la nouvelle URL
          const currentSrc = new URL(iframe.src);
          currentSrc.searchParams.set('customer_id', data.customer_id);
          currentSrc.searchParams.set('customer_email', data.customer_email);
          
          console.log('Contestio: New iframe URL:', currentSrc.toString());
          
          // ✅ DÉLAI SAFARI iOS: Petit délai avant changement d'URL
          setTimeout(() => {
            iframe.src = currentSrc.toString();
          }, 150);
          
        } else {
          console.log('Contestio: User not connected');
          showIframe();
        }
      })
      .catch(error => {
        console.error('Contestio: Fetch error:', error);
        showIframe();
      });
  }
}

// ✅ COORDINATION: Initialisation sécurisée
const initWhenReady = () => {
  if (document.getElementById('contestio-iframe')) {
    window.initContestio();
  } else {
    setTimeout(initWhenReady, 100);
  }
};

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initWhenReady);
} else {
  initWhenReady();
}
</script>