<?php
/** @var \Contestio\Connect\ViewModel\RouteChecker $viewModel */
$viewModel = $block->getData('view_model');

if ($viewModel->isContestioRoute() === false) {
  // If not contestio route, do not load React app
  return;
}

/** @var \Contestio\Connect\Block\React $block */
$iframeUrl = $block->getIframeUrl();
$queryParams = $block->getQueryParams();

?>

<style>
  /* Enlarge the container */
  main#maincontent {
    padding: 0 !important;
    max-width: 1400px !important;
    margin: 0 auto !important;
  }

  /* Make the container flex */
  .page-main>.columns,
  .page-main>.columns>.column.main {
    display: flex !important;
    width: 100% !important;
    max-width: 100% !important;
    padding: 0 !important;
    margin: 0 !important;
  }
</style>

<div class="contestio-container">
  <div class="contestio-loading" id="contestio-loading"></div>

  <iframe 
    id="contestio-iframe" 
    src="<?php echo $iframeUrl; ?><?php echo $queryParams; ?>"
    sandbo
    width="100%" 
    height="100%"
    frameborder="0" 
    allowfullscreen 
    sandbox="allow-scripts allow-same-origin allow-forms"
    class="contestio-iframe contestio-hidden">
  </iframe>
</div>

<script>
// Coordination globale
if (typeof window.contestioGlobal === 'undefined') {
  window.contestioGlobal = {
    iframeReady: false,
    customerDataLoaded: false,
    listenersSetup: false,
    callbacks: []
  };
}

if (typeof window.initContestio === 'undefined') {
  window.initContestio = () => {
    const startTime = Date.now();
    const isSafari = /Safari/.test(navigator.userAgent) && /iPhone|iPad/.test(navigator.userAgent);
    
    console.log(`🍎 [${Date.now() - startTime}ms] Contestio: React init starting - Safari iOS: ${isSafari}`);
    
    let isIframeShown = false;
    let timeoutId = null;

    const showIframe = () => {
      if (isIframeShown) {
        console.log(`🍎 [${Date.now() - startTime}ms] Contestio: Iframe already shown`);
        return;
      }
      
      isIframeShown = true;
      console.log(`🍎 [${Date.now() - startTime}ms] Contestio: Showing iframe`);
      
      if (timeoutId) {
        clearTimeout(timeoutId);
        timeoutId = null;
      }

      const loading = document.getElementById('contestio-loading');
      const iframe = document.getElementById('contestio-iframe');

      if (!loading || !iframe) {
        console.error(`🍎 [${Date.now() - startTime}ms] Contestio: Elements not found`, { loading, iframe });
        return;
      }

      loading.style.display = 'none';
      iframe.classList.remove('contestio-hidden');
      
      // ✅ COORDINATION: Notifier que l'iframe est prête
      window.contestioGlobal.iframeReady = true;
      
      // ✅ DÉLAI SAFARI iOS: Attendre avant de notifier React
      const safariDelay = isSafari ? 4000 : 2000;
      setTimeout(() => {
        // Exécuter les callbacks en attente
        window.contestioGlobal.callbacks.forEach(callback => {
          try {
            callback();
          } catch (error) {
            console.error(`🍎 [${Date.now() - startTime}ms] Contestio: Callback error:`, error);
          }
        });
        window.contestioGlobal.callbacks = [];
      }, safariDelay);
    }

    // Timeout de sécurité
    timeoutId = setTimeout(() => {
      console.log(`🍎 [${Date.now() - startTime}ms] Contestio: Security timeout reached`);
      showIframe();
    }, 8000);

    console.log(`🍎 [${Date.now() - startTime}ms] Contestio: Fetching customer data`);

    fetch('/contestio/ajax/customerData')
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        console.log(`🍎 [${Date.now() - startTime}ms] Contestio: Customer data response received`);
        return response.json();
      })
      .then(data => {
        console.log(`🍎 [${Date.now() - startTime}ms] Contestio: Customer data received`, data);
        
        // ✅ COORDINATION: Marquer les données comme chargées
        window.contestioGlobal.customerDataLoaded = true;
        
        const iframe = document.getElementById('contestio-iframe');

        if (!iframe) {
          console.error(`🍎 [${Date.now() - startTime}ms] Contestio: Iframe not found`);
          showIframe();
          return;
        }

        if (data.customer_id && data.customer_email) {
          console.log(`🍎 [${Date.now() - startTime}ms] Contestio: User connected, updating iframe URL`);
          
          // Event listener AVANT changement de src
          iframe.onload = function() {
            console.log(`🍎 [${Date.now() - startTime}ms] Contestio: Iframe loaded successfully`);
            
            // ✅ DÉLAI SAFARI iOS: Attendre un peu avant de montrer
            setTimeout(() => {
              showIframe();
            }, 2000);
          };

          // Timeout spécifique pour utilisateurs connectés
          const loginTimeout = setTimeout(() => {
            console.log(`🍎 [${Date.now() - startTime}ms] Contestio: Login timeout reached`);
            showIframe();
          }, 6000);

          // Clear le timeout si onload se déclenche
          const originalOnload = iframe.onload;
          iframe.onload = function() {
            clearTimeout(loginTimeout);
            originalOnload();
          };

          // Construire la nouvelle URL
          const currentSrc = new URL(iframe.src);
          currentSrc.searchParams.set('customer_id', data.customer_id);
          currentSrc.searchParams.set('customer_email', data.customer_email);
          
          console.log(`🍎 [${Date.now() - startTime}ms] Contestio: New iframe URL:`, currentSrc.toString());
          
          // ✅ DÉLAI SAFARI iOS: Petit délai avant changement d'URL
          setTimeout(() => {
            console.log(`🍎 [${Date.now() - startTime}ms] Contestio: Setting iframe src`);
            iframe.src = currentSrc.toString();
          }, 150);
          
        } else {
          console.log(`🍎 [${Date.now() - startTime}ms] Contestio: User not connected`);
          showIframe();
        }
      })
      .catch(error => {
        console.error(`🍎 [${Date.now() - startTime}ms] Contestio: Fetch error:`, error);
        showIframe();
      });
  }
}

// ✅ COORDINATION: Initialisation sécurisée
const initWhenReady = () => {
  const startTime = Date.now();
  console.log(`🍎 [${Date.now() - startTime}ms] Contestio: Checking if iframe element exists`);
  
  if (document.getElementById('contestio-iframe')) {
    console.log(`🍎 [${Date.now() - startTime}ms] Contestio: Iframe found, initializing`);
    window.initContestio();
  } else {
    console.log(`🍎 [${Date.now() - startTime}ms] Contestio: Iframe not found, retrying...`);
    setTimeout(initWhenReady, 100);
  }
};

console.log('🍎 Contestio: Document readyState:', document.readyState);

if (document.readyState === 'loading') {
  console.log('🍎 Contestio: Waiting for DOMContentLoaded');
  document.addEventListener('DOMContentLoaded', initWhenReady);
} else {
  console.log('🍎 Contestio: DOM ready, executing immediately');
  initWhenReady();
}
</script>